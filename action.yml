name: 'Ticket IDs Extractor'
description: 'Extractor of Task management Ticket IDs from PR title, branch name, commit messages or commit body'
inputs:
  id_prefix:
    description: 'Prefix to be match to the ticket ID'
    required: true
    default: ''
  insensitive:
    description: 'Should it be case insensitive match or not'
    required: false
    default: 'true'
outputs:
  ticket_id_list:
    description: 'List of extracted ticket IDs'
    value: ${{ steps.extract_ticket_id_list.outputs.ticket_id_list }}

runs:
  using: 'composite'
  steps:
    - name: Ticket IDs Extractor
      id: extract_ticket_id_list
      run: |
        #!/usr/bin/env bash
        set +e
        set +o pipefail
        
        TICKET_ID_LIST=()
        TICKET_REGEX="\s*${{inputs.id_prefix}}-[0-9]+\s*"
        echo "--DEBUG: Will start matching IDs with this regex: $TICKET_REGEX"
        
        if [[ $GITHUB_EVENT_NAME == 'pull_request' ]]; then
          echo "--INFO: This is a pull request event"
          
          # Extract ticket ID from PR title
          echo "--INFO: Matching ticket ID from PR title"
          TICKET_ID_LIST+=(cat $GITHUB_EVENT_PATH | jq -r '.pull_request.title' | grep -oE $TICKET_REGEX)
          
          # Extract ticket ID from PR body
          echo "--INFO: Matching ticket ID from PR body"
          TICKET_ID_LIST+=(cat $GITHUB_EVENT_PATH | jq -r '.pull_request.body' | grep -oE $TICKET_REGEX)
          
          # Extract ticket ID from branch name
          echo "--INFO: Matching ticket ID from branch name"
          TICKET_ID_LIST+=(cat $GITHUB_EVENT_PATH | jq -r '.pull_request.head.ref' | grep -oE $TICKET_REGEX)
          
          echo "--INFO: Matching ticket ID from commit messages"
          gh api $(cat $GITHUB_EVENT_PATH | jq -r '.pull_request.commits_url') | sudo tee $RUNNER_WORKSPAC/commits.json
          cat $RUNNER_WORKSPACE/commits.json | jq -r '.[].commit.message' | while read -r message; do
            TICHET_ID_LIST+=($(echo "$message" | grep -oE $TICKET_REGEX));
          done
        fi

        
        if [[ -z $TICKET_ID_LIST ]]; then
          echo "--INFO: Cound not find any ticket ID"
        else
          echo "--INFO: Extracted these ticket IDs: $TICKET_ID_LIST"
          echo "ticket_id_list=$TICKET_ID_LIST" >> "$GITHUB_OUTPUT"
        fi
      shell: bash